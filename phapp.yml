name: {{ project }}
description: 'Describe your application.'

git:
  url: 'git@bitbucket.org:drunomics/{{ project }}.git'

commands:
  setup: |
    rm -rf .env && echo -e "####\n#### .env generated by \"phapp setup <env-id>\" - re-run phapp setup to update.\n####\n" > .env
    cat .env-defaults >> .env
    # Support per environment .env additions and local overrides.
    [[ ! -f .env-$PHAPP_ENV.dist ]] || (cat .env-$PHAPP_ENV.dist >> .env)
    [[ ! -f .env.local ]] || (cat .env.local >> .env)
    echo "PHAPP_ENV=$PHAPP_ENV" > .current.env
    ./scripts/setup-base.sh
    ./scripts/generate-network-aliases.sh
  environment: |
    source dotenv/loader.sh
  build: |
    EXTRA_ARGS=$([[ $PHAPP_ENV_MODE = 'production' ]] && echo '--no-dev' || echo '');
    composer install --no-interaction $EXTRA_ARGS
  clean: |
    # Clean composer vendor via the provided script.
    composer clean
  status: |
    drush status --fields=bootstrap | grep 'bootstrap' -q
  init: |
    ./scripts/init-media-icons.sh &&
    drush sql-create -y &&
    zcat dumps/init.sql.gz | drush sql:cli &&
    drush updatedb -y &&
    # Skip config-import when there is no config.
    if [ -f config/sync/core.extension.yml ]; then
      drush phapp:apply-env-mode && drush cim -y && drush cr
    fi &&
    drush locale:check && drush locale:update
  install: |
    ./scripts/init-media-icons.sh &&
    chmod +w web/sites/default &&
    drush sql-create -y &&
    SITE=${SITE:-default} &&
    drush site-install -y --sites-subdir=$SITE --config-dir=../config/sync ${INSTALL_PROFILE:-minimal} &&
    drush en services_env_parameter -y
  update: |
    ./scripts/init-media-icons.sh &&
    drush updatedb -y &&
    # Skip config-import when there is no config.
    if [ -f config/sync/core.extension.yml ]; then
      drush phapp:apply-env-mode && drush cim -y && drush cr
    fi &&
    drush locale:check && drush locale:update
